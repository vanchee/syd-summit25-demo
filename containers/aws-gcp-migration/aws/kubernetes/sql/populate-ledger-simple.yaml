apiVersion: batch/v1
kind: Job
metadata:
  name: populate-ledger-simple
spec:
  template:
    spec:
      containers:
      - name: populate-ledger-db
        image: postgres:16.6-alpine@sha256:1d04b9ba1d4996401f2552b51beda8187f175c0645c091e4781134fc9c9a3eef
        command: 
        - /bin/bash
        - -c
        - |
          echo "Creating ledger database schema..."
          PGPASSWORD="Chiapet22!" psql -h pv-syd-summit-demo-rds.cpkg2suyynq5.ap-southeast-2.rds.amazonaws.com -p 5432 -U postgres -d ledger-db << 'EOF'
          CREATE TABLE TRANSACTIONS (
              TRANSACTION_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
              FROM_ACCT CHAR(10) NOT NULL,
              TO_ACCT CHAR(10) NOT NULL,
              FROM_ROUTE CHAR(9) NOT NULL,
              TO_ROUTE CHAR(9) NOT NULL,
              AMOUNT INT NOT NULL,
              TIMESTAMP TIMESTAMP NOT NULL
          );
          -- index account number/routing number pairs
          CREATE INDEX ON TRANSACTIONS (FROM_ACCT, FROM_ROUTE, TIMESTAMP);
          CREATE INDEX ON TRANSACTIONS (TO_ACCT, TO_ROUTE, TIMESTAMP);
          -- append only ledger; prevent updates or deletes
          CREATE RULE PREVENT_UPDATE AS
            ON UPDATE TO TRANSACTIONS
            DO INSTEAD NOTHING;
          CREATE RULE PREVENT_DELETE AS
            ON DELETE TO TRANSACTIONS
            DO INSTEAD NOTHING;
          EOF
          
          echo "Populating ledger with test data..."
          PGPASSWORD="Chiapet22!" psql -h pv-syd-summit-demo-rds.cpkg2suyynq5.ap-southeast-2.rds.amazonaws.com -p 5432 -U postgres -d ledger-db << 'EOF'
          -- Create demo transactions for test users
          INSERT INTO TRANSACTIONS (FROM_ACCT, TO_ACCT, FROM_ROUTE, TO_ROUTE, AMOUNT, TIMESTAMP) VALUES
          ('1011226111', '1033623433', '883745000', '883745000', 5000, NOW() - INTERVAL '1 day'),
          ('1033623433', '1055757655', '883745000', '883745000', 3000, NOW() - INTERVAL '2 days'),
          ('1055757655', '1077441377', '883745000', '883745000', 7500, NOW() - INTERVAL '3 days'),
          ('1077441377', '1011226111', '883745000', '883745000', 2500, NOW() - INTERVAL '4 days'),
          ('1011226111', '1033623433', '883745000', '883745000', 4000, NOW() - INTERVAL '5 days'),
          ('1033623433', '1055757655', '883745000', '883745000', 6000, NOW() - INTERVAL '6 days'),
          ('1055757655', '1077441377', '883745000', '883745000', 3500, NOW() - INTERVAL '7 days'),
          ('1077441377', '1011226111', '883745000', '883745000', 8000, NOW() - INTERVAL '8 days');
          EOF
          
          echo "Ledger database populated successfully!"
      restartPolicy: Never
  backoffLimit: 4 